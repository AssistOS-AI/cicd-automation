name: Deploy Monitoring on Webdock

on:
  workflow_dispatch:

jobs:
  deploy-monitoring:
    name: Deploy Monitoring Stack
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Deploy Monitoring Stack
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_KEY: ${{ secrets.SSH_KEY }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          ALERT_EMAIL: ${{ secrets.ALERT_EMAIL }}
        run: |
          echo "$SSH_KEY" > private_key.pem
          chmod 600 private_key.pem
          
          ssh -o StrictHostKeyChecking=no -i private_key.pem $SSH_USER@$SSH_HOST << 'EOF'
            # Create values.yaml for Loki-stack
            cat <<EOL > values.yaml
            loki:
              enabled: true
            promtail:
              enabled: true
              config:
                enabled: true
                file: |
                  server:
                    log_level: info
                  clients:
                    - url: http://loki:3100/loki/api/v1/push
                  scrape_configs:
                    - job_name: kubernetes-pods
                      kubernetes_sd_configs:
                        - role: pod
                      relabel_configs:
                        - source_labels: [__meta_kubernetes_pod_name]
                          target_label: pod
            grafana:
              enabled: false
            prometheus:
              enabled: false
            EOL
          
            # Deploy Loki-stack
            helm repo add grafana https://grafana.github.io/helm-charts
            helm repo update
            helm upgrade --install loki grafana/loki-stack --namespace monitoring --create-namespace -f values.yaml
          
            # Create prometheus-values.yaml
            cat <<EOL > prometheus-values.yaml
            alertmanager:
              enabled: true
              config:
                global:
                  resolve_timeout: 5m
                  smtp_smarthost: '$SMTP_HOST'
                  smtp_from: '$SMTP_USER'
                  smtp_auth_username: '$SMTP_USER'
                  smtp_auth_password: '$SMTP_PASSWORD'
                  smtp_require_tls: true
                route:
                  receiver: 'email-alerts'
                receivers:
                  - name: 'email-alerts'
                    email_configs:
                      - to: '$ALERT_EMAIL'
            EOL
          
            # Deploy Prometheus
            helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
            helm upgrade --install prometheus prometheus-community/kube-prometheus-stack --namespace monitoring --create-namespace -f prometheus-values.yaml
          
            # Apply ServiceMonitor for Loki
            cat <<EOL | kubectl apply -f -
            apiVersion: monitoring.coreos.com/v1
            kind: ServiceMonitor
            metadata:
              name: loki
              namespace: monitoring
              labels:
                release: prometheus
            spec:
              selector:
                matchLabels:
                  app: loki
              endpoints:
                - port: http-metrics
                  interval: 30s
            EOL
          EOF

      - name: Clean Up
        run: |
          rm -f private_key.pem